<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savings Balance Tracker</title>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e0e0e0;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #dddddd;
            --shadow: rgba(0, 0, 0, 0.1);
            --chart-grid: #e0e0e0;
            --chart-text: #666666;
            --success: #4caf50;
            --error: #f44336;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-tertiary: #3a3a3a;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #444444;
            --shadow: rgba(0, 0, 0, 0.3);
            --chart-grid: #444444;
            --chart-text: #b0b0b0;
            --success: #66bb6a;
            --error: #ef5350;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        h1 {
            font-size: 2em;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .version {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .theme-toggle {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
        }

        .theme-toggle svg {
            width: 20px;
            height: 20px;
            fill: var(--text-primary);
        }

        .theme-toggle .swap-on {
            display: block;
        }

        .theme-toggle .swap-off {
            display: none;
        }

        [data-theme="dark"] .theme-toggle .swap-on {
            display: none;
        }

        [data-theme="dark"] .theme-toggle .swap-off {
            display: block;
        }

        .github-link {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-size: 14px;
        }

        .github-link:hover {
            background: var(--bg-tertiary);
        }

        .github-link svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-primary);
        }

        .file-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .file-input-container .file-input-wrapper {
            flex-grow: 1;
        }

        .file-input-container .filter-btn {
            flex-shrink: 0;
            padding: 12px 20px;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .control-group h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
            font-size: 1.1em;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: block;
            padding: 12px 20px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            border: 2px dashed var(--border-color);
        }

        .file-input-label:hover {
            background: var(--bg-primary);
            border-color: var(--success);
        }

        .file-name {
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--text-secondary);
            height: 20px;
        }

        .filter-section {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            margin-bottom: 30px;
        }

        .filter-section h3 {
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .filter-controls {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-group label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .account-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .account-filter {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: var(--bg-primary);
            border-radius: 6px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }

        .account-filter:hover {
            background: var(--bg-tertiary);
        }

        .account-filter input[type="checkbox"] {
            cursor: pointer;
        }

        .account-filter-label {
            font-size: 0.85em;
            cursor: pointer;
            user-select: none;
        }

        .date-input {
            padding: 8px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9em;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .filter-btn {
            padding: 8px 16px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            opacity: 0.9;
        }

        .filter-btn.secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .title-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .reload-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reload-btn:hover {
            background: var(--bg-primary);
            border-color: var(--success);
        }

        .reload-btn svg {
            fill: var(--text-primary);
        }

        .chart-container {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            margin-bottom: 30px;
            position: relative;
        }

        canvas {
            width: 100%;
            display: block;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            opacity: 1;
            transition: opacity 0.3s;
        }

        .legend-item.inactive {
            opacity: 0.4;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid var(--border-color);
        }

        .data-table-container {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            overflow-x: auto;
        }

        .data-table-container h3 {
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-tertiary);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            opacity: 0.9;
        }

        .account-row {
            transition: opacity 0.2s;
        }

        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
            display: none;
        }

        .status-message.success {
            background: var(--success);
            color: white;
            display: block;
        }

        .status-message.error {
            background: var(--error);
            color: white;
            display: block;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .summary {
                grid-template-columns: 1fr;
            }
        }

        .summary-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .summary-card h4 {
            color: var(--text-secondary);
            font-size: 0.9em;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .summary-card .value {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
            
            .filter-controls {
                grid-template-columns: 1fr;
            }
            
            .summary {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
            }

            .header-actions {
                align-items: center;
            }

            .header-controls {
                width: 100%;
                justify-content: center;
            }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
        }

        .modal-content {
            background-color: var(--bg-primary);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            width: 80%;
            max-width: 900px;
            border-radius: 12px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .modal-close {
            color: var(--text-secondary);
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-close:hover,
        .modal-close:focus {
            color: var(--text-primary);
            text-decoration: none;
        }

        .content-section {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            margin-bottom: 30px;
        }

        .content-section h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .content-section p, .content-section ul, .content-section ol {
            margin-bottom: 15px;
            color: var(--text-secondary);
        }

        .content-section ul, .content-section ol {
            padding-left: 20px;
        }

        .content-section code {
            background-color: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            color: var(--text-primary);
        }

        .content-section pre {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', Courier, monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>💰 Savings Balance Tracker</h1>
            <div class="header-actions">
                <div class="header-controls">
                    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                        <svg class="swap-on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/></svg>
                        <svg class="swap-off" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/></svg>
                    </button>
                    <button class="github-link" onclick="openDocs()" title="Documentation">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                          </svg>
                        <span>Docs</span>
                    </button>
                    <a href="https://github.com/Midi12/savings-tracker.midi12.re" target="_blank" class="github-link" title="Download from GitHub">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
                        </svg>
                        <span>Source</span>
                    </a>
                </div>
                <div class="version">v1.0.0</div>
            </div>
        </header>

        <div class="controls">
            <div class="control-group">
                <h3>📊 Load Balance Data</h3>
                <div class="file-input-container">
                    <div class="file-input-wrapper">
                        <input type="file" id="balanceFile" class="file-input" accept=".csv" onchange="handleFileSelect('balance', event)">
                        <button id="balanceFileButton" class="file-input-label" onclick="openFilePicker('balance')">
                            Choose Balance CSV
                        </button>
                    </div>
                    <button class="filter-btn secondary" onclick="clearStoredCSV('balance')" title="Clear stored balance data">Clear</button>
                </div>
                <div class="file-name" id="balanceFileName"></div>
                <div class="status-message" id="balanceStatus"></div>
            </div>

            <div class="control-group">
                <h3>💱 Load Currency Conversion (Optional)</h3>
                <div class="file-input-container">
                    <div class="file-input-wrapper">
                        <input type="file" id="currencyFile" class="file-input" accept=".csv" onchange="handleFileSelect('currency', event)">
                        <button id="currencyFileButton" class="file-input-label" onclick="openFilePicker('currency')">
                            Choose Currency CSV
                        </button>
                    </div>
                    <button class="filter-btn secondary" onclick="clearStoredCSV('currency')" title="Clear stored currency data">Clear</button>
                </div>
                <div class="file-name" id="currencyFileName"></div>
                <div class="status-message" id="currencyStatus"></div>
            </div>
        </div>

        <div class="summary" id="summary" style="display: none;">
            <div class="summary-card">
                <h4>Total Accounts</h4>
                <div class="value" id="totalAccounts">0</div>
            </div>
            <div class="summary-card">
                <h4>Latest Total Balance</h4>
                <div class="value" id="totalBalance">0</div>
            </div>
            <div class="summary-card">
                <h4>Date Range</h4>
                <div class="value" id="dateRange">-</div>
            </div>
        </div>

        <div class="filter-section" id="filterSection" style="display: none;">
            <h3>🔍 Filter Options</h3>
            <div class="filter-controls">
                <div class="filter-group">
                    <label>Accounts</label>
                    <div class="account-filters" id="accountFilters"></div>
                </div>
                <div class="filter-group">
                    <label>Start Date</label>
                    <input type="date" id="startDate" class="date-input">
                </div>
                <div class="filter-group">
                    <label>End Date</label>
                    <input type="date" id="endDate" class="date-input">
                </div>
            </div>
            <div class="filter-actions">
                <button class="filter-btn" onclick="applyFilters()">Apply Filters</button>
                <button class="filter-btn secondary" onclick="resetFilters()">Reset All</button>
                <button class="filter-btn secondary" onclick="selectAllAccounts()">Select All</button>
                <button class="filter-btn secondary" onclick="deselectAllAccounts()">Deselect All</button>
            </div>
        </div>

        <div class="chart-container" id="chartContainer" style="display: none;">
            <div class="title-container">
                <h3>Balance Evolution Over Time</h3>
                <button class="reload-btn" onclick="reloadData()" title="Reload Data">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                        <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/>
                    </svg>
                </button>
            </div>
            <canvas id="chart" width="1200" height="400"></canvas>
            <div class="legend" id="legend"></div>
        </div>

        <div class="data-table-container" id="tableContainer" style="display: none;">
            <div class="title-container">
                <h3>Balance Details</h3>
                <button class="reload-btn" onclick="reloadData()" title="Reload Data">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                        <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/>
                    </svg>
                </button>
            </div>
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Account</th>
                        <th>Date</th>
                        <th>Balance</th>
                        <th>Currency</th>
                        <th>Converted Value</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let balanceData = [];
        let filteredData = [];
        let currencyData = [];
        let accountColors = {};
        let processedData = {};
        let activeFilters = {
            accounts: [],
            startDate: null,
            endDate: null
        };

        let balanceFileHandle = null;
        let currencyFileHandle = null;
        const aPIsAvailable = !!window.showOpenFilePicker;

        const colorPalette = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
            '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2',
            '#F8B739', '#52B788', '#FF6B9D', '#C9CBCF', '#A8DADC'
        ];

        function openDocs() {
            document.getElementById('docsModal').style.display = 'block';
        }

        function closeDocs(event) {
            const modal = document.getElementById('docsModal');
            if (event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            } else {
                modal.style.display = 'none';
            }
        }

        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            if (filteredData.length > 0) {
                drawChart();
            }
        }

        function clearStoredCSV(type) {
            const itemName = type === 'balance' ? 'balanceCSV' : 'currencyCSV';
            const userConfirmed = confirm(`Are you sure you want to clear the stored ${type} data?`);
            if (userConfirmed) {
                localStorage.removeItem(itemName);
                location.reload();
            }
        }

        function parseCSV(text, delimiter = ';') {
            const lines = text.split('\n')
                .map(line => line.trim())
                .filter(line => line && !line.startsWith('#'));

            if (lines.length === 0) {
                return [];
            }

            const headers = lines[0].split(delimiter).map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(delimiter).map(v => v.trim());
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.toLowerCase()] = values[index];
                    });
                    data.push(row);
                }
            }
            
            return data;
        }

        function processBalanceData(text, fileName) {
            try {
                balanceData = parseCSV(text);

                // Process and validate data
                balanceData = balanceData.map(row => ({
                    account: row['account name'] || row.account,
                    date: new Date(row.date),
                    balance: parseFloat(row.balance),
                    currency: row.currency
                })).filter(row => !isNaN(row.date.getTime()) && !isNaN(row.balance));

                // Sort by date
                balanceData.sort((a, b) => a.date - b.date);

                // Assign colors to accounts
                const accounts = [...new Set(balanceData.map(d => d.account))];
                accounts.forEach((account, index) => {
                    accountColors[account] = colorPalette[index % colorPalette.length];
                });

                // Initialize filters
                activeFilters.accounts = accounts;
                filteredData = [...balanceData];

                // Setup filter UI
                setupFilters();

                document.getElementById('balanceFileName').textContent = fileName;
                showStatus('balanceStatus', `Loaded ${balanceData.length} records from ${accounts.length} accounts from ${fileName}`, 'success');
            } catch (error) {
                showStatus('balanceStatus', 'Error parsing CSV file: ' + error.message, 'error');
                localStorage.removeItem('balanceCSV');
            }
        }

        function processCurrencyData(text, fileName) {
            try {
                currencyData = parseCSV(text);
                document.getElementById('currencyFileName').textContent = fileName;
                showStatus('currencyStatus', `Loaded ${currencyData.length} currency conversion records from ${fileName}`, 'success');
            } catch (error) {
                showStatus('currencyStatus', 'Error parsing currency CSV: ' + error.message, 'error');
                localStorage.removeItem('currencyCSV');
            }
        }

        async function openFilePicker(type) {
            if (aPIsAvailable) {
                try {
                    const [handle] = await window.showOpenFilePicker({
                        types: [{ description: 'CSV Files', accept: { 'text/csv': ['.csv'] } }],
                        multiple: false
                    });
                    if (type === 'balance') {
                        balanceFileHandle = handle;
                    } else {
                        currencyFileHandle = handle;
                    }
                    const file = await handle.getFile();
                    const text = await file.text();
                    loadFile(type, file.name, text);
                } catch (err) {
                    console.error('File picker error:', err);
                }
            } else {
                // Fallback for browsers that don't support the API
                document.getElementById(type + 'File').click();
            }
        }

        function handleFileSelect(type, event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                loadFile(type, file.name, text);
            };
            reader.readAsText(file);
        }

        function loadFile(type, name, content) {
            if (type === 'balance') {
                localStorage.setItem('balanceCSV', JSON.stringify({ name, content }));
                processBalanceData(content, name);
            } else {
                localStorage.setItem('currencyCSV', JSON.stringify({ name, content }));
                processCurrencyData(content, name);
            }

            if (balanceData.length > 0) {
                processAndDisplay();
            }
        }

        async function reloadData() {
            let balanceLoaded = false;
            if (aPIsAvailable && balanceFileHandle) {
                const file = await balanceFileHandle.getFile();
                const text = await file.text();
                processBalanceData(text, file.name);
                balanceLoaded = true;
            } else {
                const savedBalance = localStorage.getItem('balanceCSV');
                if (savedBalance) {
                    const {name, content} = JSON.parse(savedBalance);
                    processBalanceData(content, name);
                    if (balanceData.length > 0) {
                        balanceLoaded = true;
                    }
                }
            }

            if (aPIsAvailable && currencyFileHandle) {
                const file = await currencyFileHandle.getFile();
                const text = await file.text();
                processCurrencyData(text, file.name);
            } else {
                const savedCurrency = localStorage.getItem('currencyCSV');
                if (savedCurrency) {
                    const {name, content} = JSON.parse(savedCurrency);
                    processCurrencyData(content, name);
                }
            }

            if(balanceLoaded) {
                processAndDisplay();
            }
        }


        function setupFilters() {
            const filterSection = document.getElementById('filterSection');
            filterSection.style.display = 'block';
            
            // Setup account filters
            const accountFilters = document.getElementById('accountFilters');
            accountFilters.innerHTML = '';
            
            const accounts = [...new Set(balanceData.map(d => d.account))];
            accounts.forEach(account => {
                const filterDiv = document.createElement('div');
                filterDiv.className = 'account-filter';
                filterDiv.style.borderLeft = `4px solid ${accountColors[account]}`;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `filter-${account}`;
                checkbox.checked = true;
                checkbox.value = account;
                
                const label = document.createElement('label');
                label.htmlFor = `filter-${account}`;
                label.className = 'account-filter-label';
                label.textContent = account;
                
                filterDiv.appendChild(checkbox);
                filterDiv.appendChild(label);
                accountFilters.appendChild(filterDiv);
            });
            
            // Setup date filters
            const dates = balanceData.map(d => d.date);
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            
            document.getElementById('startDate').value = minDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = maxDate.toISOString().split('T')[0];
        }

        function applyFilters() {
            // Get selected accounts
            const checkboxes = document.querySelectorAll('#accountFilters input[type="checkbox"]:checked');
            activeFilters.accounts = Array.from(checkboxes).map(cb => cb.value);
            
            // Get date range
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            endDate.setHours(23, 59, 59); // Include the entire end date
            
            activeFilters.startDate = startDate;
            activeFilters.endDate = endDate;
            
            // Apply filters
            filteredData = balanceData.filter(row => {
                const accountMatch = activeFilters.accounts.includes(row.account);
                const dateMatch = row.date >= startDate && row.date <= endDate;
                return accountMatch && dateMatch;
            });
            
            // Update display
            processAndDisplay();
            updateLegendState();
        }

        function resetFilters() {
            const accounts = [...new Set(balanceData.map(d => d.account))];
            activeFilters.accounts = accounts;
            
            // Reset checkboxes
            document.querySelectorAll('#accountFilters input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            
            // Reset dates
            const dates = balanceData.map(d => d.date);
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            
            document.getElementById('startDate').value = minDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = maxDate.toISOString().split('T')[0];
            
            filteredData = [...balanceData];
            processAndDisplay();
            updateLegendState();
        }

        function selectAllAccounts() {
            document.querySelectorAll('#accountFilters input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
        }

        function deselectAllAccounts() {
            document.querySelectorAll('#accountFilters input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status-message ${type}`;
            setTimeout(() => {
                element.className = 'status-message';
            }, 5000);
        }

        function convertCurrency(amount, fromCurrency, toCurrency, date) {
            if (!currencyData.length || fromCurrency === toCurrency) {
                return amount;
            }
            
            const conversion = currencyData.find(c => 
                (c.from === fromCurrency && c.to === toCurrency) ||
                (c.source === fromCurrency && c.target === toCurrency)
            );
            
            if (conversion) {
                const rate = parseFloat(conversion.rate || conversion.value || 1);
                return amount * rate;
            }
            
            return amount;
        }

        function processAndDisplay() {
            if (filteredData.length === 0) {
                return;
            }
            
            // Group data by date and account
            processedData = {};
            filteredData.forEach(row => {
                const dateKey = row.date.toISOString().split('T')[0];
                if (!processedData[dateKey]) {
                    processedData[dateKey] = {};
                }
                processedData[dateKey][row.account] = row;
            });
            
            // Update summary
            updateSummary();
            
            // Display chart and table
            document.getElementById('chartContainer').style.display = 'block';
            document.getElementById('tableContainer').style.display = 'block';
            document.getElementById('summary').style.display = 'grid';
            
            drawChart();
            updateTable();
        }

        function updateSummary() {
            const accounts = [...new Set(filteredData.map(d => d.account))];
            document.getElementById('totalAccounts').textContent = accounts.length;
            
            // Get latest balance for each account
            const latestBalances = {};
            filteredData.forEach(row => {
                if (!latestBalances[row.account] || row.date > latestBalances[row.account].date) {
                    latestBalances[row.account] = row;
                }
            });
            
            const total = Object.values(latestBalances).reduce((sum, row) => {
                const converted = convertCurrency(row.balance, row.currency, 'EUR', row.date);
                return sum + converted;
            }, 0);
            
            document.getElementById('totalBalance').textContent = total.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }) + ' EUR';
            
            const dates = filteredData.map(d => d.date);
            if (dates.length > 0) {
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                document.getElementById('dateRange').textContent = 
                    `${minDate.toLocaleDateString()} - ${maxDate.toLocaleDateString()}`;
            } else {
                document.getElementById('dateRange').textContent = '-';
            }
        }

        function drawChart() {
            const canvas = document.getElementById('chart');
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = 800;
            
            const padding = { top: 40, right: 40, bottom: 60, left: 100 };
            const chartWidth = canvas.width - padding.left - padding.right;
            const chartHeight = canvas.height - padding.top - padding.bottom;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.scale(2, 2);
            
            if (filteredData.length === 0) {
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
                ctx.font = '16px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No data to display. Please adjust filters.', canvas.width / 4, canvas.height / 4);
                return;
            }
            
            // Get date range
            const dates = Object.keys(processedData).sort();
            const dateObjects = dates.map(d => new Date(d));
            const minDate = dateObjects[0];
            const maxDate = dateObjects[dateObjects.length - 1];
            const isSingleDate = dates.length === 1;

            // Get value range - find maximum single account value
            let maxValue = 0;
            filteredData.forEach(row => {
                const convertedValue = convertCurrency(row.balance, row.currency, 'EUR', row.date);
                maxValue = Math.max(maxValue, convertedValue);
            });
            maxValue *= 1.1; // Add 10% padding
            
            // Draw axes
            ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--chart-grid');
            ctx.lineWidth = 1;
            
            // Y-axis
            ctx.beginPath();
            ctx.moveTo(padding.left / 2, padding.top / 2);
            ctx.lineTo(padding.left / 2, (chartHeight + padding.top) / 2);
            ctx.stroke();
            
            // X-axis
            ctx.beginPath();
            ctx.moveTo(padding.left / 2, (chartHeight + padding.top) / 2);
            ctx.lineTo((chartWidth + padding.left) / 2, (chartHeight + padding.top) / 2);
            ctx.stroke();
            
            // Draw grid lines and labels
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--chart-text');
            ctx.font = '12px sans-serif';
            
            // Y-axis labels
            for (let i = 0; i <= 5; i++) {
                const value = (maxValue * i) / 5;
                const y = (chartHeight + padding.top) / 2 - (chartHeight * i) / 10;
                
                ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--chart-grid');
                ctx.globalAlpha = 0.3;
                ctx.beginPath();
                ctx.moveTo(padding.left / 2, y);
                ctx.lineTo((chartWidth + padding.left) / 2, y);
                ctx.stroke();
                ctx.globalAlpha = 1;
                
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--chart-text');
                ctx.textAlign = 'right';
                ctx.fillText(value.toLocaleString(undefined, {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }), (padding.left / 2) - 10, y + 4);
            }
            
            // Get filtered accounts
            const accounts = activeFilters.accounts;
            
            // Draw lines for each account
            accounts.forEach(account => {
                ctx.strokeStyle = accountColors[account];
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                // Get all data points for this account
                const accountData = filteredData
                    .filter(d => d.account === account)
                    .sort((a, b) => a.date - b.date);
                
                if (!isSingleDate) {
                    accountData.forEach((point, idx) => {
                        const dateKey = point.date.toISOString().split('T')[0];
                        const dateIndex = dates.indexOf(dateKey);
                        
                        if (dateIndex !== -1) {
                            const x = (padding.left + (dateIndex * chartWidth) / (dates.length - 1)) / 2;
                            const value = convertCurrency(point.balance, point.currency, 'EUR', point.date);
                            const y = (chartHeight + padding.top) / 2 - (value * chartHeight) / (maxValue * 2);

                            if (idx === 0) {
                                ctx.moveTo(x, y);
                            } else {
                                ctx.lineTo(x, y);
                            }
                        }
                    });
                }
                
                ctx.stroke();
                
                // Draw points
                accountData.forEach(point => {
                    const dateKey = point.date.toISOString().split('T')[0];
                    const dateIndex = dates.indexOf(dateKey);
                    
                    if (dateIndex !== -1) {
                        const x = isSingleDate
                            ? (padding.left + chartWidth / 2) / 2
                            : (padding.left + (dateIndex * chartWidth) / (dates.length - 1)) / 2;
                        const value = convertCurrency(point.balance, point.currency, 'EUR', point.date);
                        const y = (chartHeight + padding.top) / 2 - (value * chartHeight) / (maxValue * 2);
                        
                        ctx.fillStyle = accountColors[account];
                        ctx.beginPath();
                        ctx.arc(x, y, 3, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });
            });
            
            // Draw X-axis labels (dates)
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--chart-text');
            ctx.textAlign = 'center';

            if (isSingleDate) {
                const x = (padding.left + chartWidth / 2) / 2;
                const dateObj = new Date(dates[0]);
                ctx.save();
                ctx.translate(x, (chartHeight + padding.top) / 2 + 20);
                ctx.rotate(-Math.PI / 4);
                ctx.textAlign = 'right';
                ctx.fillText(dateObj.toLocaleDateString(), 0, 0);
                ctx.restore();
            } else {
                const labelInterval = Math.ceil(dates.length / 10);
                dates.forEach((date, index) => {
                    if (index % labelInterval === 0 || index === dates.length - 1) {
                        const x = (padding.left + (index * chartWidth) / (dates.length - 1)) / 2;
                        const dateObj = new Date(date);
                        ctx.save();
                        ctx.translate(x, (chartHeight + padding.top) / 2 + 20);
                        ctx.rotate(-Math.PI / 4);
                        ctx.textAlign = 'right';
                        ctx.fillText(dateObj.toLocaleDateString(), 0, 0);
                        ctx.restore();
                    }
                });
            }
            
            // Update legend
            const allAccounts = [...new Set(balanceData.map(d => d.account))];
            updateLegend(allAccounts);
        }

        function updateLegend(accounts) {
            const legendContainer = document.getElementById('legend');
            legendContainer.innerHTML = '';
            
            accounts.forEach(account => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                if (!activeFilters.accounts.includes(account)) {
                    item.classList.add('inactive');
                }
                
                const color = document.createElement('div');
                color.className = 'legend-color';
                color.style.backgroundColor = accountColors[account];
                
                const label = document.createElement('span');
                label.textContent = account;
                
                item.appendChild(color);
                item.appendChild(label);
                legendContainer.appendChild(item);
            });
        }

        function updateLegendState() {
            const legendItems = document.querySelectorAll('.legend-item');
            const allAccounts = [...new Set(balanceData.map(d => d.account))];
            
            legendItems.forEach((item, index) => {
                const account = allAccounts[index];
                if (activeFilters.accounts.includes(account)) {
                    item.classList.remove('inactive');
                } else {
                    item.classList.add('inactive');
                }
            });
        }

        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            // Show most recent data first
            const sortedData = [...filteredData].sort((a, b) => b.date - a.date);
            
            sortedData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'account-row';
                
                // Set row background color based on account color with transparency
                const color = accountColors[row.account];
                // Convert hex to RGB for transparency
                const r = parseInt(color.slice(1, 3), 16);
                const g = parseInt(color.slice(3, 5), 16);
                const b = parseInt(color.slice(5, 7), 16);
                tr.style.backgroundColor = `rgba(${r}, ${g}, ${b}, 0.15)`;
                
                const accountTd = document.createElement('td');
                accountTd.textContent = row.account;
                accountTd.style.fontWeight = '500';
                
                const dateTd = document.createElement('td');
                dateTd.textContent = row.date.toLocaleDateString();
                
                const balanceTd = document.createElement('td');
                balanceTd.textContent = row.balance.toLocaleString(undefined, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                const currencyTd = document.createElement('td');
                currencyTd.textContent = row.currency;
                
                const convertedTd = document.createElement('td');
                const converted = convertCurrency(row.balance, row.currency, 'EUR', row.date);
                convertedTd.textContent = converted.toLocaleString(undefined, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }) + ' EUR';
                
                tr.appendChild(accountTd);
                tr.appendChild(dateTd);
                tr.appendChild(balanceTd);
                tr.appendChild(currencyTd);
                tr.appendChild(convertedTd);
                
                tbody.appendChild(tr);
            });
        }

        // Set initial theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.body.setAttribute('data-theme', savedTheme);
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.setAttribute('data-theme', 'dark');
        }

        document.addEventListener('DOMContentLoaded', reloadData);
    </script>

    <div id="docsModal" class="modal" onclick="closeDocs(event)">
        <div class="modal-content">
            <span class="modal-close" onclick="closeDocs()">&times;</span>
            <div class="content-section">
                <h2>How to Use the Application</h2>
                <p>The Savings Balance Tracker is a tool designed to help you visualize your financial account balances over time. Here's a step-by-step guide:</p>
                <ol>
                    <li><strong>Load Your Balance Data:</strong>
                        <ul>
                            <li>Click the "Choose Balance CSV File" button.</li>
                            <li>Select the CSV file from your computer that contains your account balances.</li>
                            <li>The application will automatically process the data and display a chart, summary, and data table.</li>
                        </ul>
                    </li>
                    <li><strong>Load Currency Conversion Data (Optional):</strong>
                        <ul>
                            <li>If your accounts are in different currencies, you can provide a currency conversion file.</li>
                            <li>Click the "Choose Currency CSV File" button and select your conversion rates file.</li>
                            <li>The app will use these rates to convert all balances to a single currency (EUR by default) for the chart and summary calculations.</li>
                        </ul>
                    </li>
                    <li><strong>Filter Your Data:</strong>
                        <ul>
                            <li>Use the "Filter Options" section to narrow down your view.</li>
                            <li><strong>Accounts:</strong> Check or uncheck account names to show or hide them from the chart and table.</li>
                            <li><strong>Date Range:</strong> Select a start and end date to focus on a specific period.</li>
                            <li>Click "Apply Filters" to update the view. You can also reset filters or select/deselect all accounts.</li>
                        </ul>
                    </li>
                    <li><strong>Explore the Visualizations:</strong>
                        <ul>
                            <li><strong>Chart:</strong> The chart shows the evolution of your account balances over time.</li>
                            <li><strong>Summary:</strong> The summary cards provide a quick overview of the number of accounts, the latest total balance, and the currently displayed date range.</li>
                            <li><strong>Data Table:</strong> The table shows the raw data for the filtered period, with color-coding to match the accounts in the chart.</li>
                        </ul>
                    </li>
                </ol>
            </div>

            <div class="content-section">
                <h2>Balance CSV File Format</h2>
                <p>Your balance data must be in a CSV file with a specific structure. The file must use a <strong>semicolon (;)</strong> as the delimiter.</p>
                <p>The required columns are:</p>
                <ul>
                    <li><code>Account name</code> or <code>account</code>: The name of the financial account.</li>
                    <li><code>date</code>: The date of the balance record in <code>YYYY-MM-DD</code> format.</li>
                    <li><code>balance</code>: The numerical balance of the account.</li>
                    <li><code>currency</code>: The three-letter currency code (e.g., EUR, USD, GBP).</li>
                </ul>
                <p><strong>Example:</strong></p>
    <pre><code>Account name;date;balance;currency
    Checking Account;2024-01-15;5234.50;EUR
    Savings Account;2024-01-15;12500.00;EUR
    Investment Portfolio;2024-01-15;8750.25;USD
    </code></pre>
            </div>

            <div class="content-section">
                <h2>Currency CSV File Format</h2>
                <p>The currency conversion file is optional. It is used to convert different currencies into a single base currency for unified reporting. This file must also use a <strong>semicolon (;)</strong> as the delimiter.</p>
                <p>The required columns are:</p>
                <ul>
                    <li><code>from</code> or <code>source</code>: The source currency code.</li>
                    <li><code>to</code> or <code>target</code>: The target currency code.</li>
                    <li><code>rate</code> or <code>value</code>: The conversion rate (how many 'to' units you get for one 'from' unit).</li>
                </ul>
                <p><strong>Example:</strong></p>
    <pre><code>from;to;rate
    USD;EUR;0.92
    GBP;EUR;1.16
    </code></pre>
                <p>In this example, 1 USD is converted to 0.92 EUR, and 1 GBP is converted to 1.16 EUR.</p>
            </div>
        </div>
    </div>
</body>
</html>